<!-- <!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mage Character Sheet</title>
  </head>
  <body class="bg-gray-100 text-gray-900">
    <div id="root"></div>
    <script type="module" src="/main.jsx"></script>
  </body>
</html>
 -->

 <!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mage Character Sheet</title>

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'class' }</script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 dark:text-white">
  <div id="root"></div>

  <!-- React + ReactDOM UMD builds -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel Standalone for JSX/ESNext -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Your app code, transpiled on-the-fly -->
  <script type="text/babel">
    const { useReducer, useEffect, useCallback, useState } = React;

    // Initial state shape
    const initial = {
      info: { Name:'', Path:'', Order:'', Legacy:'', Virtue:'', Vice:'' },
      attributes: {}, arcana: {}, skills: {},
      merits: [], conditions: [], aspirations:['','',''], obsessions:[],
      healthBoxes: Array(10).fill(''), willpowerBoxes: Array(10).fill(''),
      mana:0, gnosis:1, wisdom:0, beats:0, arcaneBeats:0, experience:0, arcaneExperience:0, size:5
    };

    // Reducer
    function reducer(state, action) {
      switch(action.type) {
        case 'load': return { ...action.character };
        case 'updateInfo':
          return { ...state, info:{ ...state.info, [action.field]: action.value } };
        case 'updateAttribute':
          return { ...state, attributes:{ ...state.attributes, [action.attr]: action.value } };
        case 'updateArcana':
          return { ...state, arcana:{ ...state.arcana, [action.arc]: action.value } };
        case 'updateSkill':
          return { ...state, skills:{ ...state.skills, [action.skill]: action.entry } };
        case 'addMerit':
          if (state.merits.some(m=>m.name===action.merit)) return state;
          return { ...state, merits:[ ...state.merits, { name:action.merit, dots:1 } ] };
        case 'updateMerit':
          let m = [...state.merits]; m[action.index] = action.entry;
          return { ...state, merits:m };
        case 'removeMerit':
          return { ...state, merits: state.merits.filter((_,i)=>i!==action.index) };
        case 'addCondition':
          if(!action.condition.trim()) return state;
          return { ...state, conditions:[ ...state.conditions, action.condition.trim() ] };
        case 'removeCondition':
          return { ...state, conditions: state.conditions.filter((_,i)=>i!==action.index) };
        case 'updateGnosis':
          return { 
            ...state,
            gnosis: action.value,
            mana: Math.min(state.mana, [10,11,12,13,15,20,25,30,50,75][action.value-1])
          };
        case 'updateMana':
          return {
            ...state,
            mana: Math.max(0, Math.min(action.value, [10,11,12,13,15,20,25,30,50,75][state.gnosis-1]))
          };
        case 'updateObsession':
          let obs = [...state.obsessions]; obs[action.index] = action.value;
          return { ...state, obsessions:obs };
        case 'updateHealthBoxes':
          return { ...state, healthBoxes: action.healthBoxes };
        case 'updateWillpowerBoxes':
          return { ...state, willpowerBoxes: action.willpowerBoxes };
        case 'increment':
          return { ...state, [action.field]: state[action.field] + 1 };
        case 'decrement':
          return { ...state, [action.field]: Math.max(0, state[action.field] - 1) };
        default:
          return state;
      }
    }

    // DotRow Component
    function DotRow({ count=5, value=0, onChange }) {
      const handleKey=(i,e)=>{ if(e.key==='Enter'||e.key===' '){e.preventDefault(); onChange(i+1);} };
      return <div className="flex space-x-1">
        {Array.from({length:count}).map((_,i)=>(
          <button key={i}
            role="slider" aria-valuemin={0} aria-valuemax={count} aria-valuenow={value}
            title={`${i+1} dots`}
            onClick={()=>onChange(i+1)} onKeyDown={e=>handleKey(i,e)} tabIndex={0}
            className={`w-5 h-5 rounded-full border-2 ${i < value ? 'bg-black':'bg-white'} border-black focus:outline-none focus:ring-2`}
          />
        ))}
      </div>;
    }

    // BoxRow Component
    function BoxRow({ count=10, value=[], onChange }) {
      const toggle=i=>{
        const v = value[i]==='L' ? 'A' : value[i]==='A' ? '' : 'L';
        let arr = [...value]; arr[i]=v; onChange(arr);
      };
      const handleKey=(i,e)=>{ if(e.key==='Enter'||e.key===' '){e.preventDefault(); toggle(i);} };
      return <div className="flex space-x-1">
        {Array.from({length:count}).map((_,i)=>(
          <button key={i}
            title="Box"
            onClick={()=>toggle(i)} onKeyDown={e=>handleKey(i,e)} tabIndex={0}
            className={`w-5 h-5 border text-xs font-bold rounded focus:outline-none focus:ring-2 ${
              value[i]==='L'?'bg-yellow-400':value[i]==='A'?'bg-red-600 text-white':'bg-white'
            } border-black`}
          >{value[i]}</button>
        ))}
      </div>;
    }

    // Main App
    function App() {
      const [state, dispatch] = useReducer(reducer, initial);
      const [list, setList] = useState([]);
      const [sel, setSel] = useState('');

      const REFRESH=useCallback(()=>{
        setList(Object.keys(localStorage).filter(k=>k.startsWith('mageCharacter_')));
      },[]);
      useEffect(()=>{ REFRESH(); },[REFRESH]);

      // Auto-save on change
      useEffect(()=>{
        if (!state.info.Name) return;
        const h=setTimeout(()=>{
          localStorage.setItem(`mageCharacter_${state.info.Name}`, JSON.stringify(state));
          setSel(`mageCharacter_${state.info.Name}`);
          REFRESH();
        },300);
        return()=>clearTimeout(h);
      },[state,REFRESH]);

      // Load
      const loadChar=key=>{
        let raw=localStorage.getItem(key);
        if(!raw) return;
        dispatch({ type:'load', character: JSON.parse(raw) });
        setSel(key);
      };

      // Export
      const exportJSON=()=>{
        const b=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
        const u=URL.createObjectURL(b);
        let a=document.createElement('a');
        a.href=u; a.download=`${state.info.Name||'character'}.json`; a.click();
        URL.revokeObjectURL(u);
      };

      return (
        <div className="max-w-5xl mx-auto p-4 space-y-6">
          {/* Dropdown */}
          <div className="flex gap-2">
            <select value={sel} onChange={e=>loadChar(e.target.value)}
              className="p-1 border rounded bg-white dark:bg-gray-700">
              <option value="">Select Character</option>
              {list.map(k=><option key={k} value={k}>{k.replace('mageCharacter_','')}</option>)}
            </select>
            <button onClick={()=>dispatch({type:'load', character:initial})}
              className="bg-yellow-500 text-white px-2 py-1 rounded">New</button>
            <button onClick={exportJSON}
              className="bg-gray-700 text-white px-2 py-1 rounded">Export</button>
          </div>

          {/* Info */}
          <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
            {Object.entries(state.info).map(([k,v])=>(
              <input key={k} value={v} placeholder={k}
                onChange={e=>dispatch({type:'updateInfo',field:k,value:e.target.value})}
                className="p-2 border rounded bg-white dark:bg-gray-700"/>
            ))}
          </div>

          {/* Attributes */}
          <div className="grid grid-cols-3 gap-4">
            {['Intelligence','Wits','Resolve','Strength','Dexterity','Stamina','Presence','Manipulation','Composure']
              .map(attr=>(
                <div key={attr}>
                  <label>{attr}</label>
                  <DotRow value={state.attributes[attr]||0}
                    onChange={val=>dispatch({type:'updateAttribute',attr,value:val})}/>
                </div>
              ))}
          </div>

          {/* Skills */}
          <h3 className="font-semibold">Skills</h3>
          <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
            {['Academics','Computer','Crafts','Investigation','Medicine','Occult','Politics','Science',
              'Athletics','Brawl','Drive','Firearms','Larceny','Stealth','Survival','Weaponry',
              'Animal Ken','Empathy','Expression','Intimidation','Persuasion','Socialize','Streetwise','Subterfuge']
              .map(skill=>(
                <div key={skill}>
                  <label>{skill}</label>
                  <DotRow value={state.skills[skill]?.dots||0}
                    onChange={val=>dispatch({type:'updateSkill',skill,entry:{dots:val,specialty:state.skills[skill]?.specialty||''}})}/>
                  <input placeholder="Specialty" value={state.skills[skill]?.specialty||''}
                    onChange={e=>dispatch({type:'updateSkill',skill,entry:{dots:state.skills[skill]?.dots||0,specialty:e.target.value}})}
                    className="w-full text-xs mt-1 p-1 border rounded bg-white dark:bg-gray-700"/>
                </div>
              ))}
          </div>

          {/* Arcana */}
          <h3 className="font-semibold">Arcana</h3>
          <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
            {['Death','Fate','Forces','Life','Matter','Mind','Prime','Space','Spirit','Time']
              .map(ar=>(
                <div key={ar}>
                  <label>{ar}</label>
                  <DotRow value={state.arcana[ar]||0}
                    onChange={val=>dispatch({type:'updateArcana',arc:ar,value:val})}/>
                </div>
              ))}
          </div>

          {/* (you can continue the rest of Sections similarly…) */}

        </div>
      );
    }

    // Mount
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
